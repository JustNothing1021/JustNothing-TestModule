#!/system/bin/sh

# 并发测试脚本

VERSION="0.1.0"
METHODS_WORKDIR="/data/local/tmp/methods"
NATIVE_CLIENT="/system/framework/methods_client"

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

color_red() { echo -e "${RED}$1${NC}"; }
color_green() { echo -e "${GREEN}$1${NC}"; }
color_yellow() { echo -e "${YELLOW}$1${NC}"; }
color_cyan() { echo -e "${CYAN}$1${NC}"; }

# 测试并发执行
test_concurrent() {
    local num_clients=$1
    local command=$2
    
    color_cyan "开始并发测试"
    color_cyan "客户端数量: $num_clients"
    color_cyan "命令: $command"
    echo
    
    local start_time=$(date +%s)
    local success_count=0
    local fail_count=0
    
    # 并发执行
    for i in $(seq 1 $num_clients); do
        (
            local result=$("$NATIVE_CLIENT" "$command" 2>&1)
            if [ $? -eq 0 ]; then
                echo "[客户端 $i] 成功"
            else
                echo "[客户端 $i] 失败"
            fi
        ) &
    done
    
    # 等待所有后台任务完成
    wait
    
    local end_time=$(date +%s)
    local duration=$((end_time - start_time))
    
    echo
    color_cyan "测试完成"
    color_cyan "总耗时: ${duration}秒"
    echo
}

# 测试并发类加载器
test_concurrent_classloader() {
    local num_clients=$1
    
    color_cyan "测试并发类加载器"
    color_cyan "客户端数量: $num_clients"
    echo
    
    local packages=("com.android.systemui" "com.android.settings" "com.android.launcher3")
    
    for i in $(seq 1 $num_clients); do
        local pkg_index=$((i % ${#packages[@]}))
        local pkg="${packages[$pkg_index]}"
        
        (
            local result=$("$NATIVE_CLIENT" "-cl $pkg packages" 2>&1)
            if [ $? -eq 0 ]; then
                echo "[客户端 $i] 成功 (包: $pkg)"
            else
                echo "[客户端 $i] 失败 (包: $pkg)"
            fi
        ) &
    done
    
    wait
    echo
    color_cyan "测试完成"
    echo
}

# 测试并发内存操作
test_concurrent_memory() {
    local num_clients=$1
    
    color_cyan "测试并发内存操作"
    color_cyan "客户端数量: $num_clients"
    echo
    
    for i in $(seq 1 $num_clients); do
        (
            local result=$("$NATIVE_CLIENT" "memory minfo" 2>&1)
            if [ $? -eq 0 ]; then
                echo "[客户端 $i] 成功"
            else
                echo "[客户端 $i] 失败"
            fi
        ) &
    done
    
    wait
    echo
    color_cyan "测试完成"
    echo
}

# 测试并发反射操作
test_concurrent_reflect() {
    local num_clients=$1
    
    color_cyan "测试并发反射操作"
    color_cyan "客户端数量: $num_clients"
    echo
    
    for i in $(seq 1 $num_clients); do
        (
            local result=$("$NATIVE_CLIENT" "reflect java.lang.System currentTimeMillis" 2>&1)
            if [ $? -eq 0 ]; then
                echo "[客户端 $i] 成功"
            else
                echo "[客户端 $i] 失败"
            fi
        ) &
    done
    
    wait
    echo
    color_cyan "测试完成"
    echo
}

# 压力测试
stress_test() {
    local num_clients=$1
    local duration=$2
    
    color_cyan "开始压力测试"
    color_cyan "客户端数量: $num_clients"
    color_cyan "持续时间: ${duration}秒"
    echo
    
    local start_time=$(date +%s)
    local end_time=$((start_time + duration))
    local total_requests=0
    
    while [ $(date +%s) -lt $end_time ]; do
        for i in $(seq 1 $num_clients); do
            (
                "$NATIVE_CLIENT" "invoke java.lang.System currentTimeMillis" >/dev/null 2>&1
                if [ $? -eq 0 ]; then
                    echo "[请求 $((total_requests + i))] 成功"
                fi
            ) &
            total_requests=$((total_requests + num_clients))
        done
        wait
        sleep 1
    done
    
    echo
    color_cyan "压力测试完成"
    color_cyan "总请求数: $total_requests"
    echo
}

# 显示帮助
show_help() {
    echo "并发测试脚本 v$VERSION"
    echo ""
    echo "用法:"
    echo "  $0 <测试类型> [参数...]"
    echo ""
    echo "测试类型:"
    echo "  concurrent <客户端数量> <命令>         - 并发执行命令"
    echo "  classloader <客户端数量>               - 测试并发类加载器"
    echo "  memory <客户端数量>                    - 测试并发内存操作"
    echo "  reflect <客户端数量>                   - 测试并发反射操作"
    echo "  stress <客户端数量> <持续时间(秒)>      - 压力测试"
    echo "  help                                 - 显示帮助"
    echo ""
    echo "示例:"
    echo "  $0 concurrent 10 \"invoke java.lang.System currentTimeMillis\""
    echo "  $0 classloader 5"
    echo "  $0 memory 10"
    echo "  $0 reflect 10"
    echo "  $0 stress 20 60"
}

# 主函数
main() {
    local test_type="$1"
    
    case "$test_type" in
        concurrent)
            if [ $# -lt 3 ]; then
                color_red "参数不足"
                show_help
                exit 1
            fi
            test_concurrent "$2" "$3"
            ;;
        classloader)
            if [ $# -lt 2 ]; then
                color_red "参数不足"
                show_help
                exit 1
            fi
            test_concurrent_classloader "$2"
            ;;
        memory)
            if [ $# -lt 2 ]; then
                color_red "参数不足"
                show_help
                exit 1
            fi
            test_concurrent_memory "$2"
            ;;
        reflect)
            if [ $# -lt 2 ]; then
                color_red "参数不足"
                show_help
                exit 1
            fi
            test_concurrent_reflect "$2"
            ;;
        stress)
            if [ $# -lt 3 ]; then
                color_red "参数不足"
                show_help
                exit 1
            fi
            stress_test "$2" "$3"
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            color_red "未知测试类型: $test_type"
            echo ""
            show_help
            exit 1
            ;;
    esac
}

main "$@"
